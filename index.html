<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Universal Hybrid v47</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Rajdhani:wght@600;800;900&display=swap" rel="stylesheet">
    <style>
        body { background-color: #000; color: #fff; font-family: 'Rajdhani', sans-serif; display: flex; justify-content: center; align-items: center; min-height: 100vh; margin: 0; padding: 10px; }
        .panel { width: 100%; max-width: 480px; background: #050505; border: 1px solid #222; border-radius: 20px; padding: 20px; box-shadow: 0 0 50px rgba(255, 215, 0, 0.05); }
        
        .status-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; border-bottom: 1px solid #1a1a1a; padding-bottom: 10px; }
        .model-badge { font-size: 10px; font-weight: bold; background: #111; padding: 4px 8px; border-radius: 4px; border: 1px solid #333; color: #888; }
        
        .pred-display { background: #0a0a0a; border: 2px solid #333; border-radius: 15px; padding: 30px; text-align: center; margin-bottom: 20px; position: relative; }
        .main-text { font-size: 5rem; font-weight: 900; line-height: 1; }
        .sub-nums { display: flex; justify-content: center; gap: 10px; margin-top: 15px; }
        .num-box { width: 50px; height: 50px; background: #151515; border: 1px solid #444; border-radius: 10px; display: flex; align-items: center; justify-content: center; font-size: 1.5rem; font-weight: bold; color: #ffd700; }
        
        .stats-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px; margin-bottom: 20px; }
        .stat-card { background: #0f0f0f; padding: 10px; text-align: center; border-radius: 8px; border: 1px solid #222; }
        .stat-val { font-size: 18px; font-weight: bold; }
        
        table { width: 100%; font-size: 11px; border-collapse: collapse; }
        th { text-align: left; color: #555; padding: 8px; border-bottom: 1px solid #222; }
        td { padding: 10px 5px; border-bottom: 1px solid #1a1a1a; font-weight: bold; }
        
        .failover-active { border-color: #ff0000; animation: flashRed 1s; }
        @keyframes flashRed { 0% { border-color: #333; } 50% { border-color: #ff0000; } 100% { border-color: #333; } }
    </style>
</head>
<body>

    <div class="panel">
        <div class="status-header">
            <div>
                <h1 class="text-sm font-black text-gray-300">SUPREME v47</h1>
                <div class="flex items-center gap-2 mt-1">
                    <div id="live-dot" class="w-2 h-2 rounded-full bg-green-500 animate-pulse"></div>
                    <span id="sys-msg" class="text-[9px] font-bold text-green-500 uppercase">ONLINE</span>
                </div>
            </div>
            <div class="text-right">
                <div class="model-badge" id="active-model">AUTO-HYBRID</div>
                <div class="text-[10px] font-bold text-yellow-500 mt-1" id="timer">00s</div>
            </div>
        </div>

        <div class="pred-display" id="main-box">
            <div class="absolute top-2 left-2 text-[10px] font-bold text-gray-600">TARGET: <span id="target-display" class="text-white">#----</span></div>
            <h2 id="p-text" class="main-text text-gray-700">--</h2>
            <div class="sub-nums">
                <div class="num-box" id="n1">?</div>
                <div class="num-box" id="n2" style="border-color:#00f3ff; color:#00f3ff;">?</div>
            </div>
        </div>

        <div class="stats-grid">
            <div class="stat-card border-b-2 border-green-500"><span class="block text-[9px] text-gray-500">WINS</span><span id="w-val" class="stat-val text-green-500">0</span></div>
            <div class="stat-card border-b-2 border-red-500"><span class="block text-[9px] text-gray-500">LOSS</span><span id="l-val" class="stat-val text-red-500">0</span></div>
            <div class="stat-card border-b-2 border-yellow-500"><span class="block text-[9px] text-gray-500">JACKPOT</span><span id="j-val" class="stat-val text-yellow-500">0</span></div>
        </div>

        <div class="bg-[#080808] rounded-xl border border-[#1a1a1a] p-2" style="max-height: 200px; overflow-y: auto;">
            <table>
                <thead><tr><th>Issue</th><th>Pred</th><th>Result</th><th>Log</th></tr></thead>
                <tbody id="history-rows"></tbody>
            </table>
        </div>
    </div>

    <script>
        // --- 1. CONFIGURATION ---
        const CONFIG = {
            tunnel: "https://wingo.ahmadalisafdar86.workers.dev/",
            key: "AIzaSyBhKbxUkpHHyo08b0EDJe_M1zymG9l7tP4",
            api: "https://draw.ar-lottery01.com/WinGo/WinGo_1M/GetHistoryIssuePage.json?pageSize=30",
            // PRIORITY LIST: Try 2.5 first, if fails, fallback to 1.5
            models: ["gemini-2.5-flash", "gemini-1.5-flash"] 
        };

        // --- 2. STATE VARIABLES ---
        let historyData = [];
        let lastProcessed = null;
        let stats = { w: 0, l: 0, j: 0 };
        let isRunning = false;

        // --- 3. MAIN ENGINE ---
        async function startEngine() {
            if(isRunning) return;
            isRunning = true;
            
            try {
                updateStatus("FETCHING DATA...", "yellow");
                const res = await fetch(`${CONFIG.tunnel}?url=${encodeURIComponent(CONFIG.api + "&ts=" + Date.now())}`);
                const json = await res.json();
                const list = json.data.list;
                const latest = list[0].issueNumber;

                // Validate Previous
                if(historyData.length > 0 && historyData[0].status === "WAIT") {
                    const result = list.find(r => r.issueNumber === historyData[0].issue);
                    if(result) checkWin(historyData[0], result);
                }

                // Calculate Target
                const target = (BigInt(latest) + 1n).toString();
                document.getElementById('target-display').innerText = "#" + target.slice(-4);

                // Predict if New
                if (lastProcessed !== target) {
                    lastProcessed = target;
                    // Start Hybrid AI Call
                    await attemptPrediction(list, target);
                } else {
                    updateStatus("WAITING NEXT...", "green");
                }

            } catch (e) {
                updateStatus("TUNNEL ERROR", "red");
            } finally {
                isRunning = false;
            }
        }

        // --- 4. HYBRID AI CALL (The Fix) ---
        async function attemptPrediction(list, target) {
            document.getElementById('p-text').innerText = "...";
            document.getElementById('p-text').className = "main-text text-gray-600 animate-pulse";

            const prompt = `Analyze Wingo History: ${JSON.stringify(list.slice(0, 15).map(x=>x.totalNumber))}. Next Period ${target}. Output JSON: {"p":"BIG/SMALL","n":[x,y]}`;

            // Try Models in Order
            for (let model of CONFIG.models) {
                try {
                    updateStatus(`TRYING ${model.toUpperCase()}...`, "blue");
                    
                    const url = `https://generativelanguage.googleapis.com/v1/models/${model}:generateContent?key=${CONFIG.key}`;
                    const response = await fetch(url, {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] })
                    });

                    if (!response.ok) throw new Error("Busy");

                    const data = await response.json();
                    const text = data.candidates[0].content.parts[0].text.replace(/```json|```/g, "").trim();
                    const pred = JSON.parse(text);

                    // SUCCESS
                    document.getElementById('active-model').innerText = model.includes('2.5') ? "2.5 FLASH (MAX)" : "1.5 FLASH (SAFE)";
                    document.getElementById('active-model').className = model.includes('2.5') ? "model-badge text-green-400" : "model-badge text-yellow-400";
                    
                    showResult(pred);
                    addToTable(target, pred);
                    updateStatus("PREDICTION LOCKED", "green");
                    return; // Stop loop on success

                } catch (err) {
                    console.log(`${model} Failed, switching...`);
                    // If failed, loop continues to next model
                }
            }
            
            updateStatus("ALL AI BUSY - RETRYING", "red");
            setTimeout(() => { lastProcessed = null; startEngine(); }, 2000); // Auto Retry
        }

        // --- 5. UI LOGIC ---
        function showResult(data) {
            const el = document.getElementById('p-text');
            el.innerText = data.p;
            el.className = `main-text ${data.p === 'BIG' ? 'text-green-500' : 'text-red-500'}`;
            document.getElementById('n1').innerText = data.n[0];
            document.getElementById('n2').innerText = data.n[1];
        }

        function addToTable(issue, pred) {
            historyData.unshift({ issue: issue, p: pred.p, n: pred.n, status: "WAIT", res: "?" });
            if(historyData.length > 8) historyData.pop();
            renderTable();
        }

        function checkWin(entry, actual) {
            const num = parseInt(actual.totalNumber);
            const size = num >= 5 ? "BIG" : "SMALL";
            const win = entry.p === size;
            const jp = entry.n.includes(num);

            entry.res = `${num} (${size[0]})`;
            
            if(win && jp) { entry.status = "âœ… ðŸŽ‰"; stats.w++; stats.j++; }
            else if(win) { entry.status = "âœ…"; stats.w++; }
            else { entry.status = "âŒ"; stats.l++; }

            document.getElementById('w-val').innerText = stats.w;
            document.getElementById('l-val').innerText = stats.l;
            document.getElementById('j-val').innerText = stats.j;
            
            renderTable();
        }

        function renderTable() {
            document.getElementById('history-rows').innerHTML = historyData.map(h => `
                <tr class="border-b border-[#1a1a1a]">
                    <td class="text-gray-400">#${h.issue.slice(-4)}</td>
                    <td class="${h.p === 'BIG' ? 'text-green-500' : 'text-red-500'} font-bold">${h.p}</td>
                    <td class="text-yellow-500 font-bold">${h.res}</td>
                    <td>${h.status}</td>
                </tr>
            `).join('');
        }

        function updateStatus(msg, color) {
            const t = document.getElementById('sys-msg');
            const d = document.getElementById('live-dot');
            t.innerText = msg;
            t.className = `text-[9px] font-bold text-${color}-500 uppercase`;
            d.className = `w-2 h-2 rounded-full bg-${color}-500 ${color === 'green' || color === 'yellow' ? 'animate-pulse' : ''}`;
        }

        // Timer
        setInterval(() => {
            const s = new Date().getSeconds();
            document.getElementById('timer').innerText = (60-s)+"s";
            if(s === 2) startEngine();
        }, 1000);

        startEngine();

    </script>
</body>
</html>
